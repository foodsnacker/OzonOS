#!/usr/bin/env python3
"""
convert_icons.py - Convert 2-bit icon data to 8-bit icon data in NASM format.

2-bit encoding (LSB-first within each byte):
  bits 1:0 = pixel 0, bits 3:2 = pixel 1, bits 5:4 = pixel 2, bits 7:6 = pixel 3
  Values: 00=transparent(0x00), 01=darkgrey(0x08), 10=lightgrey(0x07), 11=white(0x0F)

Each icon gets a per-icon color mapping applied after base decode.
"""

import os

# Base 2-bit value to 8-bit color mapping
BASE_COLOR_MAP = {
    0: 0x00,  # transparent
    1: 0x08,  # dark grey
    2: 0x07,  # light grey
    3: 0x0F,  # white
}

# Per-icon color substitutions (applied after base decode)
COLOR_CLOSE    = {0x07: 0x0C, 0x08: 0x04}          # light red, dark red
COLOR_DEPTH    = {0x07: 0x09, 0x08: 0x01}          # light blue, dark blue
COLOR_GRAY     = {}                                 # keep grayscale
COLOR_BUSY     = {0x07: 0x0B}                       # light cyan
COLOR_WARNING  = {0x07: 0x0E, 0x08: 0x06}          # yellow, brown
COLOR_INFO     = {0x07: 0x09}                       # light blue
COLOR_ERROR    = {0x07: 0x0C}                       # light red
COLOR_MENU     = {0x07: 0x0B}                       # light cyan
COLOR_PATTERN  = {0x07: 0x09}                       # light blue
COLOR_FOLDER   = {0x07: 0x0E}                       # yellow
COLOR_DOCUMENT = {0x07: 0x0B}                       # light cyan

# Icon definitions: (name, bytes_per_row, height, data_bytes, color_map)
ICONS = [
    ("closeNormal", 3, 12, [
        0xFF,0xFF,0xFF, 0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA,
        0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA,
        0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA, 0xAA,0xAA,0xAA, 0xFF,0xFF,0xFF,
    ], COLOR_CLOSE),

    ("closePressed", 3, 12, [
        0xFF,0xFF,0xFF, 0x55,0x55,0x55, 0x55,0x55,0x55, 0x55,0x55,0x55,
        0x55,0x55,0x55, 0x55,0x55,0x55, 0x55,0x55,0x55, 0x55,0x55,0x55,
        0x55,0x55,0x55, 0x55,0x55,0x55, 0x55,0x55,0x55, 0xFF,0xFF,0xFF,
    ], COLOR_CLOSE),

    ("depthNormal", 3, 12, [
        0xFF,0xFF,0xFF, 0xFA,0xAA,0xBF, 0xFA,0xAA,0xBF, 0xFA,0xFF,0xFF,
        0xFA,0xAA,0xAF, 0xFA,0xAA,0xAF, 0xFF,0xAA,0xAF, 0xAA,0xAA,0xAF,
        0xAA,0xAA,0xAF, 0xAA,0xAA,0xAF, 0xAA,0xAA,0xAF, 0xFF,0xFF,0xFF,
    ], COLOR_DEPTH),

    ("depthPressed", 3, 12, [
        0xFF,0xFF,0xFF, 0xF5,0x55,0x5F, 0xF5,0x55,0x5F, 0xF5,0xFF,0xFF,
        0xF5,0x55,0x5F, 0xF5,0x55,0x5F, 0xFF,0x55,0x5F, 0x55,0x55,0x5F,
        0x55,0x55,0x5F, 0x55,0x55,0x5F, 0x55,0x55,0x5F, 0xFF,0xFF,0xFF,
    ], COLOR_DEPTH),

    ("sizeNormal", 3, 12, [
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0xF0, 0x00,0x00,0xFF,
        0x00,0x00,0xFF, 0x00,0xF0,0xFF, 0x00,0xFF,0xFF, 0xF0,0xFF,0xFF,
    ], COLOR_GRAY),

    ("sizePressed", 3, 12, [
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
        0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0xA0, 0x00,0x00,0xAA,
        0x00,0x00,0xAA, 0x00,0xA0,0xAA, 0x00,0xAA,0xAA, 0xA0,0xAA,0xAA,
    ], COLOR_GRAY),

    ("scrollUp", 3, 10, [
        0x00,0xF0,0x00, 0x00,0xFF,0x00, 0x0F,0xFF,0x00, 0x0F,0xAF,0x00,
        0xFA,0xAF,0xA0, 0x00,0xAA,0x00, 0x00,0xAA,0x00, 0x00,0xAA,0x00,
        0x00,0xAA,0x00, 0x00,0x00,0x00,
    ], COLOR_GRAY),

    ("scrollDown", 3, 10, [
        0x00,0x00,0x00, 0x00,0xAA,0x00, 0x00,0xAA,0x00, 0x00,0xAA,0x00,
        0x00,0xAA,0x00, 0xFA,0xAF,0xA0, 0x0F,0xAF,0x00, 0x0F,0xFF,0x00,
        0x00,0xFF,0x00, 0x00,0xF0,0x00,
    ], COLOR_GRAY),

    ("scrollLeft", 3, 10, [
        0x00,0x00,0x00, 0x00,0xF0,0x00, 0x00,0xFF,0x00, 0x0F,0xFA,0x00,
        0xFA,0xAA,0x00, 0xFA,0xAA,0x00, 0x0F,0xFA,0x00, 0x00,0xFF,0x00,
        0x00,0xF0,0x00, 0x00,0x00,0x00,
    ], COLOR_GRAY),

    ("scrollRight", 3, 10, [
        0x00,0x00,0x00, 0x00,0xF0,0x00, 0x00,0xFF,0x00, 0x00,0xAF,0xF0,
        0x00,0xAA,0xFA, 0x00,0xAA,0xFA, 0x00,0xAF,0xF0, 0x00,0xFF,0x00,
        0x00,0xF0,0x00, 0x00,0x00,0x00,
    ], COLOR_GRAY),

    ("busyAnim0", 3, 12, [
        0x00,0xFF,0x00, 0x0F,0xAA,0x00, 0xF0,0xAA,0x00, 0xF0,0xAA,0x00,
        0xF0,0xAA,0x00, 0xF0,0xAA,0x00, 0xF0,0xAA,0x00, 0xF0,0xAA,0x00,
        0xF0,0xAA,0x00, 0xF0,0xAA,0x00, 0x0F,0xAA,0x00, 0x00,0xFF,0x00,
    ], COLOR_BUSY),

    ("busyAnim1", 3, 12, [
        0xFF,0xF0,0x00, 0xAA,0xF0,0x00, 0xAA,0xF0,0x00, 0xAA,0xF0,0x00,
        0xAA,0xF0,0x00, 0xAA,0xF0,0x00, 0xAA,0xF0,0x00, 0xAA,0xF0,0x00,
        0xAA,0xF0,0x00, 0xAA,0xF0,0x00, 0xAA,0x0F,0x00, 0xFF,0x00,0x00,
    ], COLOR_BUSY),

    ("busyAnim2", 3, 12, [
        0x00,0xFF,0x00, 0x00,0xAA,0xF0, 0x00,0xAA,0x0F, 0x00,0xAA,0x0F,
        0x00,0xAA,0x0F, 0x00,0xAA,0x0F, 0x00,0xAA,0x0F, 0x00,0xAA,0x0F,
        0x00,0xAA,0x0F, 0x00,0xAA,0x0F, 0x00,0xAA,0xF0, 0x00,0xFF,0x00,
    ], COLOR_BUSY),

    ("busyAnim3", 3, 12, [
        0x00,0x0F,0xFF, 0x00,0x0F,0xAA, 0xF0,0x0F,0xAA, 0xF0,0x0F,0xAA,
        0xF0,0x0F,0xAA, 0xF0,0x0F,0xAA, 0xF0,0x0F,0xAA, 0xF0,0x0F,0xAA,
        0xF0,0x0F,0xAA, 0xF0,0x0F,0xAA, 0x00,0x0F,0xAA, 0x00,0x0F,0xFF,
    ], COLOR_BUSY),

    ("checkboxOff", 2, 8, [
        0xFF,0xFF, 0xF0,0x0F, 0xF0,0x0F, 0xF0,0x0F,
        0xF0,0x0F, 0xF0,0x0F, 0xF0,0x0F, 0xFF,0xFF,
    ], COLOR_GRAY),

    ("checkboxOn", 2, 8, [
        0xFF,0xFF, 0xF0,0xFF, 0xF0,0xAF, 0xFA,0xAF,
        0xFA,0x0F, 0xFF,0x0F, 0xF0,0x0F, 0xFF,0xFF,
    ], COLOR_GRAY),

    ("radioOff", 3, 8, [
        0x00,0xFF,0x00, 0x0F,0x00,0xF0, 0xF0,0x00,0x0F, 0xF0,0x00,0x0F,
        0xF0,0x00,0x0F, 0xF0,0x00,0x0F, 0x0F,0x00,0xF0, 0x00,0xFF,0x00,
    ], COLOR_GRAY),

    ("radioOn", 3, 8, [
        0x00,0xFF,0x00, 0x0F,0x00,0xF0, 0xF0,0xFF,0x0F, 0xF0,0xFF,0x0F,
        0xF0,0xFF,0x0F, 0xF0,0xFF,0x0F, 0x0F,0x00,0xF0, 0x00,0xFF,0x00,
    ], COLOR_GRAY),

    ("sysWarning", 4, 16, [
        0x00,0x00,0xF0,0x00, 0x00,0x0F,0xF0,0x00, 0x00,0x0F,0xAF,0x00,
        0x00,0xFA,0xAF,0x00, 0x00,0xFA,0xFA,0x00, 0x0F,0xA0,0xFA,0x00,
        0x0F,0xA0,0xAF,0x00, 0xFA,0x00,0xAF,0x00, 0xFA,0x00,0xFA,0x00,
        0xF0,0x00,0xFA,0x00, 0xF0,0xF0,0xAF,0x00, 0xFA,0xFA,0xAF,0x00,
        0xFF,0xFF,0xFF,0x00, 0xFF,0xFF,0xFF,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_WARNING),

    ("sysInfo", 4, 16, [
        0x00,0x0F,0xF0,0x00, 0x00,0xFA,0xAF,0x00, 0x0F,0xA0,0x0A,0xF0,
        0xF0,0x0F,0xF0,0x0F, 0xF0,0x0F,0xF0,0x0F, 0xF0,0x00,0xF0,0x0F,
        0xF0,0x00,0xF0,0x0F, 0xF0,0x00,0xF0,0x0F, 0xF0,0x00,0xF0,0x0F,
        0xF0,0x00,0xF0,0x0F, 0xF0,0x0F,0xF0,0x0F, 0x0F,0xA0,0x0A,0xF0,
        0x00,0xFA,0xAF,0x00, 0x00,0x0F,0xF0,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_INFO),

    ("sysError", 4, 16, [
        0x00,0x0F,0xF0,0x00, 0x00,0xFA,0xAF,0x00, 0x0F,0xAF,0xFA,0xF0,
        0xF0,0xFA,0xAF,0x0F, 0xF0,0x0F,0xF0,0x0F, 0xF0,0x00,0x00,0x0F,
        0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F, 0xF0,0x00,0x00,0x0F,
        0xF0,0x0F,0xF0,0x0F, 0xF0,0xFA,0xAF,0x0F, 0x0F,0xAF,0xFA,0xF0,
        0x00,0xFA,0xAF,0x00, 0x00,0x0F,0xF0,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_ERROR),

    ("menuFile", 2, 8, [
        0xFF,0xF0, 0xFA,0xAF, 0xFF,0xFF, 0xFA,0xAA,
        0xFA,0xAA, 0xFA,0xAA, 0xFA,0xAA, 0xFF,0xFF,
    ], COLOR_MENU),

    ("menuEdit", 2, 8, [
        0x00,0x00, 0x00,0x0F, 0x00,0xF0, 0x0F,0xA0,
        0xF0,0xA0, 0xF0,0x00, 0xFF,0x00, 0x00,0x00,
    ], COLOR_MENU),

    ("menuView", 2, 8, [
        0x0F,0xF0, 0xFA,0xAF, 0xF0,0x0F, 0xF0,0xF0,
        0xF0,0xF0, 0xF0,0x0F, 0xFA,0xAF, 0x0F,0xF0,
    ], COLOR_MENU),

    ("menuTools", 2, 8, [
        0x00,0xFF, 0x00,0xAF, 0xF0,0xAF, 0xFA,0x0F,
        0x0F,0xA0, 0x0F,0x00, 0x0F,0x00, 0x00,0x00,
    ], COLOR_MENU),

    ("menuHelp", 2, 8, [
        0x0F,0xF0, 0xFA,0xAF, 0x00,0xAF, 0x00,0xF0,
        0x00,0xF0, 0x00,0x00, 0x00,0xF0, 0x00,0x00,
    ], COLOR_MENU),

    ("patternTitlebar", 2, 8, [
        0xAA,0xAA, 0xFF,0xFF, 0xAA,0xAA, 0xFF,0xFF,
        0xAA,0xAA, 0xFF,0xFF, 0xAA,0xAA, 0xFF,0xFF,
    ], COLOR_PATTERN),

    ("patternBorderV", 2, 8, [
        0xF0,0x00, 0xF0,0x00, 0xF0,0x00, 0xF0,0x00,
        0xF0,0x00, 0xF0,0x00, 0xF0,0x00, 0xF0,0x00,
    ], COLOR_PATTERN),

    ("patternBorderH", 2, 8, [
        0xFF,0xFF, 0xFF,0xFF, 0x00,0x00, 0x00,0x00,
        0x00,0x00, 0x00,0x00, 0x00,0x00, 0x00,0x00,
    ], COLOR_PATTERN),

    ("iconDisk", 4, 16, [
        0xFF,0xFF,0xFF,0xFF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFA,0xAA,0xAA,0xAF, 0xFF,0xFF,0xFF,0xFF, 0xFA,0xAA,0xAA,0xAF,
        0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFF,0xFF,0xFF,0xFF, 0xF0,0x00,0x00,0x0F, 0xFF,0xFF,0xFF,0xFF,
        0x00,0x00,0x00,0x00,
    ], COLOR_GRAY),

    ("iconFolder", 4, 16, [
        0x00,0x00,0x00,0x00, 0x00,0xFF,0xF0,0x00, 0x00,0xFA,0xAF,0x00,
        0xFF,0xFF,0xFF,0xFF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF, 0xFA,0xAA,0xAA,0xAF,
        0xFF,0xFF,0xFF,0xFF, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_FOLDER),

    ("iconDocument", 4, 16, [
        0x00,0xFF,0xFF,0x00, 0x00,0xFA,0xAF,0x00, 0x00,0xFA,0xFF,0xF0,
        0x00,0xFA,0xAA,0xAF, 0x00,0xFA,0xAA,0xAF, 0x00,0xFF,0xFF,0xAF,
        0x00,0xFA,0xAA,0xAF, 0x00,0xFA,0xAA,0xAF, 0x00,0xFF,0xFF,0xAF,
        0x00,0xFA,0xAA,0xAF, 0x00,0xFA,0xAA,0xAF, 0x00,0xFA,0xAA,0xAF,
        0x00,0xFF,0xFF,0xFF, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_DOCUMENT),

    ("iconTrash", 4, 16, [
        0x00,0x00,0x00,0x00, 0x00,0xFF,0xFF,0x00, 0x00,0xFA,0xAF,0x00,
        0xFF,0xFF,0xFF,0xFF, 0x0F,0xAA,0xAA,0xF0, 0x0F,0xAA,0xAA,0xF0,
        0x0F,0xAA,0xAA,0xF0, 0x0F,0xAA,0xAA,0xF0, 0x0F,0xAA,0xAA,0xF0,
        0x0F,0xAA,0xAA,0xF0, 0x00,0xFA,0xAF,0x00, 0x00,0xFA,0xAF,0x00,
        0x00,0x0F,0xF0,0x00, 0x00,0x00,0x00,0x00, 0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,
    ], COLOR_GRAY),
]


def decode_byte_lsb(byte_val):
    """Decode one 2-bit packed byte into 4 8-bit pixels (LSB-first).
    
    bits 1:0 = pixel 0, bits 3:2 = pixel 1,
    bits 5:4 = pixel 2, bits 7:6 = pixel 3
    """
    pixels = []
    for i in range(4):
        two_bit = (byte_val >> (i * 2)) & 0x03
        pixels.append(BASE_COLOR_MAP[two_bit])
    return pixels


def apply_color_map(pixels, color_map):
    """Apply per-icon color substitutions to decoded 8-bit pixels."""
    if not color_map:
        return pixels
    return [color_map.get(p, p) for p in pixels]


def format_pixel(val):
    """Format a pixel value as 0xHH."""
    return "0x{:02X}".format(val)


def convert_icon(name, bytes_per_row, height, data, color_map):
    """Convert one icon's 2-bit data to 8-bit NASM assembly lines."""
    pixels_per_row = bytes_per_row * 4
    lines = []
    lines.append("{}:".format(name))
    
    # Verify data length
    expected = bytes_per_row * height
    if len(data) != expected:
        raise ValueError(
            "Icon '{}': expected {} bytes, got {}".format(name, expected, len(data))
        )
    
    for row in range(height):
        row_start = row * bytes_per_row
        row_bytes = data[row_start:row_start + bytes_per_row]
        
        # Decode all bytes in this row to 8-bit pixels
        row_pixels = []
        for b in row_bytes:
            row_pixels.extend(decode_byte_lsb(b))
        
        # Apply color mapping
        row_pixels = apply_color_map(row_pixels, color_map)
        
        # Format as db line
        pixel_strs = ", ".join(format_pixel(p) for p in row_pixels)
        lines.append("    db {}    ; Row {}".format(pixel_strs, row))
    
    return lines


def main():
    script_dir = os.path.dirname(os.path.abspath(__file__))
    output_path = os.path.join(script_dir, "icons_8bit.asm")
    
    output_lines = []
    output_lines.append("; =============================================================================")
    output_lines.append("; icons_8bit.asm - 8-bit (VGA palette index) icon data")
    output_lines.append("; Generated by convert_icons.py from 2-bit gui_icons.asm data")
    output_lines.append("; =============================================================================")
    output_lines.append(";")
    output_lines.append("; Each pixel is one byte: VGA 256-color palette index")
    output_lines.append("; 0x00 = transparent (skip when drawing)")
    output_lines.append("; Color mappings applied per icon for visual distinction")
    output_lines.append(";")
    output_lines.append("; Color legend:")
    output_lines.append(";   0x00 = transparent    0x01 = dark blue     0x04 = dark red")
    output_lines.append(";   0x06 = brown          0x07 = light grey    0x08 = dark grey")
    output_lines.append(";   0x09 = light blue     0x0B = light cyan    0x0C = light red")
    output_lines.append(";   0x0E = yellow         0x0F = white")
    output_lines.append(";")
    output_lines.append("")
    output_lines.append("iconDataStart_8bit:")
    output_lines.append("")
    
    for i, (name, bpr, height, data, cmap) in enumerate(ICONS):
        pixels_per_row = bpr * 4
        output_lines.append("; --- {} ({}x{}) ---".format(name, pixels_per_row, height))
        icon_lines = convert_icon(name, bpr, height, data, cmap)
        output_lines.extend(icon_lines)
        output_lines.append("")
    
    output_lines.append("iconDataEnd_8bit:")
    output_lines.append("")
    
    with open(output_path, "w") as f:
        f.write("\n".join(output_lines))
    
    print("Written 8-bit icon data to: {}".format(output_path))
    print("Total icons converted: {}".format(len(ICONS)))
    
    # Print summary
    total_pixels = 0
    for name, bpr, height, data, cmap in ICONS:
        px = bpr * 4 * height
        total_pixels += px
        print("  {:20s}: {:2d}x{:2d} = {:4d} pixels ({:3d} bytes 2-bit -> {:4d} bytes 8-bit)".format(
            name, bpr*4, height, px, len(data), px))
    print("  Total: {} bytes of 8-bit pixel data".format(total_pixels))


if __name__ == "__main__":
    main()
